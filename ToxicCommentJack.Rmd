---
title: "Toxic Comment Classifier"
output: html_notebook
---

### Libraries

```{r, message = FALSE, warning = FALSE}
library(readr)
library(stringi)
library(quanteda)
library(dplyr)
library(caret)
library(glmnet)
library(doParallel)
#registerDoParallel(7)
#registerDoParallel(2)
```

### Importing and Cleaning

```{r, warning = FALSE, message = FALSE}
set.seed(999)
train = read_csv("train.csv")
train = train[1:100000,]
sample = sample(nrow(train), nrow(train)/2)
test = train[-sample,]
train = train[sample,]
#test = read_csv("test.csv")
#swear <- read_csv("swear.csv", col_names = "word")

train$id2 = rep(1:nrow(train))
test$id2 = rep(1:nrow(test))

idtrain = 1:nrow(train)
idtest = (nrow(train)+1):(nrow(train) + nrow(test))
traintest = rbind(train[,1:2], test[1:2])
gc()
```

### Variable Creation

```{r}
traintest = rbind(train[,1:2], test[1:2])
traintest = mutate(traintest,
       length = stri_length(comment_text),
       ncap = stri_count_charclass(comment_text, "[A-Z]"),
       nnum = stri_count_charclass(comment_text, "[0-9]"),
       ncap_len = ncap / length,
       nnum_len = nnum / length,
       nexcl = stri_count_fixed(comment_text, "!"),
       nquest = stri_count_fixed(comment_text, "?"),
       npunct = stri_count_charclass(comment_text, "[[:punct:]]"),
       npunct_len = npunct / length,
       nsent = stri_count_boundaries(comment_text, "sentence"),
       nsymb = stri_count_regex(comment_text, "&|@|#|\\$|%|\\*|\\^"),
       nsmile = stri_count_regex(comment_text, "((?::|;|=)(?:-)?(?:\\)|D|P))"),
       nwords = stri_count_words(comment_text),
       ntokens = 1,
       ntokens_nwords = ntokens / nwords
       )
train = cbind(train, traintest[idtrain,3:ncol(traintest)])
test = cbind(test, traintest[idtest,3:ncol(traintest)])

## quanteda
ttcorp = corpus(traintest$comment_text)
ttdfm = dfm(ttcorp, remove = stopwords("english"))
ttdfm = dfm_trim(ttdfm, min_docfreq = 200, max_docfreq = 100000)
ttdfm = dfm_sort(ttdfm)

# sparse matrix
sumttdfm = summary(ttdfm)
sparsettdfm = sparseMatrix(i = sumttdfm$i, j = sumttdfm$j, x = sumttdfm$x)

sparsetrain = Matrix(as.matrix(train[3:24]), sparse = TRUE)
sparsetest = Matrix(as.matrix(test[3:24]), sparse = TRUE)
train = cbind(sparsetrain, sparsettdfm[1:nrow(train),])
test = cbind(sparsetest, sparsettdfm[(nrow(train)+1):(nrow(train) + nrow(test)),])
```


### Testing

```{r}
toxicglm = cv.glmnet(as.matrix(train[,8:dim(train)[2]]), 
                     train[,1], 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 30)
toxicpreds = predict(toxicglm, newx = test[,8:dim(test)[2]])
toxicpreds = ifelse(toxicpreds > 0.5, 1 ,0)
confusionMatrix(toxicpreds, test[,1])

severe_toxicglm = cv.glmnet(as.matrix(train[,8:dim(train)[2]]), 
                     train[,2], 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
severe_toxicpreds = predict(severe_toxicglm, newx = test[,8:dim(test)[2]])
severe_toxicpreds = ifelse(severe_toxicpreds > 0.5, 1 ,0)
confusionMatrix(severe_toxicpreds, test[,2])

obsceneglm = cv.glmnet(as.matrix(train[,8:dim(train)[2]]), 
                     train[,3], 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
obscenepreds = predict(obsceneglm, newx = test[,8:dim(test)[2]])
obscenepreds = ifelse(obscenepreds > 0.5, 1 ,0)
confusionMatrix(obscenepreds, test[,3])

threatglm = cv.glmnet(as.matrix(train[,8:dim(train)[2]]), 
                     train[,4], 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
threatpreds = predict(threatglm, newx = test[,8:dim(test)[2]])
threatpreds = ifelse(threatpreds > 0.5, 1 ,0)
confusionMatrix(threatpreds, test[,4])

insultglm = cv.glmnet(as.matrix(train[,8:dim(train)[2]]), 
                     train[,5], 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
insultpreds = predict(insultglm, newx = test[,8:dim(test)[2]])
insultpreds = ifelse(insultpreds > 0.5, 1 ,0)
confusionMatrix(insultpreds, test[,5])

identity_hateglm = cv.glmnet(as.matrix(train[,8:dim(train)[2]]), 
                     train[,6], 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
identity_hatepreds = predict(identity_hateglm, newx = test[,8:dim(test)[2]])
identity_hatepreds = ifelse(identity_hatepreds > 0.5, 1 ,0)
confusionMatrix(identity_hatepreds, test[,6])
```

