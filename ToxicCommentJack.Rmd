---
title: "Toxic Comment Classifier"
output: html_notebook
---

### Libraries

```{r, message = FALSE, warning = FALSE}
library(readr)
library(stringi)
library(quanteda)
library(dplyr)
library(caret)
library(glmnet)
library(doParallel)
#registerDoParallel(4)
registerDoParallel(2)
```

### Importing and Cleaning

```{r, warning = FALSE, message = FALSE}
set.seed(999)
train = read_csv("train.csv")
train = train[1:100000,]
sample = sample(nrow(train), nrow(train)/2)
test = train[-sample,]
train = train[sample,]
#test = read_csv("test.csv")
#swear <- read_csv("swear.csv", col_names = "word")

train$id2 = rep(1:nrow(train))
test$id2 = rep(1:nrow(test))

idtrain = 1:nrow(train)
idtest = (nrow(train)+1):(nrow(train) + nrow(test))
traintest = rbind(train[,1:2], test[1:2])
gc()
```

### Variable Creation

```{r}
traintest = rbind(train[,1:2], test[1:2])
ttcorp = corpus(traintest$comment_text)
traintest = mutate(traintest,
       length = stri_length(comment_text),
       ncap = stri_count_charclass(comment_text, "[A-Z]"),
       nnum = stri_count_charclass(comment_text, "[0-9]"),
       ncap_len = ncap / length,
       nnum_len = nnum / length,
       nexcl = stri_count_fixed(comment_text, "!"),
       nquest = stri_count_fixed(comment_text, "?"),
       npunct = stri_count_charclass(comment_text, "[[:punct:]]"),
       npunct_len = npunct / length,
       nsent = stri_count_boundaries(comment_text, "sentence"),
       nsymb = stri_count_regex(comment_text, "&|@|#|\\$|%|\\*|\\^"),
       nsmile = stri_count_regex(comment_text, "((?::|;|=)(?:-)?(?:\\)|D|P))"),
       nwords = stri_count_words(comment_text),
       ntokens = 1,
       ntokens_nwords = ntokens / nwords
       )
train = cbind(train, traintest[idtrain,3:ncol(traintest)])
test = cbind(test, traintest[idtest,3:ncol(traintest)])

## quanteda
traintestcorpus = corpus(traintest$comment_text)
ttdfm = dfm(traintestcorpus, remove = stopwords("english"))

#traintest = cbind(traintest, ttdfm)


```


### Testing

```{r}
toxicglm = cv.glmnet(as.matrix(train[c(10:22,24)]), 
                     train$toxic, 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
toxicpreds = predict(toxicglm, as.matrix(test[c(10:22,24)]))
toxicpreds = ifelse(toxicpreds > 0.5, 1 ,0)
confusionMatrix(toxicpreds, test$toxic)

severe_toxicglm = cv.glmnet(as.matrix(train[c(10:22,24)]), 
                     train$severe_toxic, 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
severe_toxicpreds = predict(severe_toxicglm, as.matrix(test[c(10:22,24)]))
severe_toxicpreds = ifelse(severe_toxicpreds > 0.5, 1 ,0)
confusionMatrix(severe_toxicpreds, test$severe_toxic)

insultglm = cv.glmnet(as.matrix(train[c(10:22,24)]), 
                     train$insult, 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
insultpreds = predict(insultglm, as.matrix(test[c(10:22,24)]))
insultpreds = ifelse(insultpreds > 0.5, 1 ,0)
confusionMatrix(insultpreds, test$insult)

obsceneglm = cv.glmnet(as.matrix(train[c(10:22,24)]), 
                     train$obscene, 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
obscenepreds = predict(obsceneglm, as.matrix(test[c(10:22,24)]))
obscenepreds = ifelse(obscenepreds > 0.5, 1 ,0)
confusionMatrix(obscenepreds, test$obscene)

threatglm = cv.glmnet(as.matrix(train[c(10:22,24)]), 
                     train$threat, 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
threatpreds = predict(threatglm, as.matrix(test[c(10:22,24)]))
threatpreds = ifelse(threatpreds > 0.5, 1 ,0)
confusionMatrix(threatpreds, test$threat)

identity_hateglm = cv.glmnet(as.matrix(train[c(10:22,24)]), 
                     train$identity_hate, 
                     alpha = 0, 
                     family = "binomial", 
                     type.measure = "auc",
                     parallel = T,
                     nfolds = 4,
                     standardize = T,
                     nlambda = 50)
identity_hatepreds = predict(identity_hateglm, as.matrix(test[c(10:22,24)]))
identity_hatepreds = ifelse(identity_hatepreds > 0.5, 1 ,0)
confusionMatrix(identity_hatepreds, test$identity_hate)
```

